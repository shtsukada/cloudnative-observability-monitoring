{{- /*
Netpol: kube-state-metrics ingress を Prometheus からのみ許可
未定義でも落ちないように、すべての .Values アクセスを default/get で保護する
*/ -}}

{{- $np := default (dict) .Values.networkPolicy -}}
{{- $ksm := default (dict) (get $np "kubeStateMetrics") -}}
{{- $selectors := default (dict) (get $np "selectors") -}}
{{- $ports := default (dict) (get $np "ports") -}}

{{- $npEnabled := default false (get $np "enabled") -}}
{{- $allowFromProm := default false (get $ksm "allowFromPrometheus") -}}
{{- $selKsm := default (dict) (get $selectors "kubeStateMetrics") -}}
{{- $selProm := default (dict) (get $selectors "prometheus") -}}
{{- $portKsm := default 8080 (get $ports "kubeStateMetricsHttp") -}}

{{- if and $npEnabled $allowFromProm }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-np-kube-state-metrics-ingress
  namespace: {{ .Release.Namespace }}
spec:
  podSelector:
    {{- toYaml $selKsm | nindent 4 }}
  policyTypes: [Ingress]
  ingress:
    - from:
        - podSelector:
            {{- toYaml $selProm | nindent 12 }}
      ports:
        - protocol: TCP
          port: {{ $portKsm }}
{{- end }}
