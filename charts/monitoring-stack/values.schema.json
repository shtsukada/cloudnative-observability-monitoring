{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "monitoring-stack values schema",
  "type": "object",
  "properties": {
    "global": {
      "type": "object",
      "properties": {
        "namespace": { "type": "string", "default": "monitoring" }
      },
      "additionalProperties": true
    },
    "contracts": {
      "type": "object",
      "properties": {
        "grafana": {
          "type": "object",
          "properties": {
            "adminSecretName": { "type": "string", "default": "grafana-admin" }
          },
          "additionalProperties": true
        },
        "datasources": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "loki": {
              "type": "object",
              "properties": {
                "url": {
                  "type": "string",
                  "pattern": "^https?://",
                  "default": "http://loki.monitoring.svc:3100"
                }
              },
              "required": ["url"],
              "additionalProperties": false
            },
            "tempo": {
              "type": "object",
              "properties": {
                "url": {
                  "type": "string",
                  "pattern": "^https?://",
                  "default": "http://tempo.monitoring.svc:3200"
                }
              },
              "required": ["url"],
              "additionalProperties": false
            }
          },
          "required": ["enabled", "loki", "tempo"],
          "additionalProperties": false
        },
        "logs": {
          "type": "object",
          "properties": {
            "toLoki": { "type": "boolean", "default": false }
          },
          "additionalProperties": true
        },
        "traces": {
          "type": "object",
          "properties": {
            "toTempo": { "type": "boolean", "default": false }
          },
          "additionalProperties": true
        }
      },
      "required": ["datasources"],
      "additionalProperties": true
    },
    "kps": {
      "type": "object",
      "description": "Alias of kube-prometheus-stack; only minimal keys validated to stay compatible with upstream.",
      "properties": {
        "grafana": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean", "default": true },
            "defaultDatasourceEnabled": { "type": "boolean", "default": true },
            "service": {
              "type": "object",
              "properties": {
                "type": { "type": "string", "enum": ["ClusterIP", "NodePort", "LoadBalancer"], "default": "ClusterIP" },
                "nodePort": { "type": "integer", "minimum": 1 }
              },
              "additionalProperties": true
            },
            "adminPassword": { "type": "string" },
            "additionalDataSources": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "uid": { "type": "string" },
                  "type": { "type": "string" },
                  "access": { "type": "string" },
                  "url": { "type": "string", "pattern": "^https?://" },
                  "isDefault": { "type": "boolean" },
                  "jsonData": { "type": "object" }
                },
                "required": ["name", "type", "url"],
                "additionalProperties": true
              },
              "default": []
            }
          },
          "additionalProperties": true
        },
        "prometheus": { "type": "object", "additionalProperties": true },
        "alertmanager": { "type": "object", "additionalProperties": true }
      },
      "additionalProperties": true
    },
    "monitors": {
      "type": "object",
      "description": "ServiceMonitor / PodMonitor を values で駆動する設定",
      "properties": {
        "prometheus": {
          "type": "object",
          "properties": {
            "namespace": { "type": "string" },
            "labels": {
              "type": "object",
              "properties": {
                "release": {
                  "type": "string",
                  "description": "Prometheus が拾うためのラベル (例: cno-mon)"
                }
              },
              "required": ["release"],
              "additionalProperties": true
            }
          },
          "additionalProperties": false
        },
        "common": {
          "type": "object",
          "description": "endpoints のデフォルト値",
          "properties": {
            "scrapeInterval": {
              "type": "string",
              "pattern": "^[0-9]+(ms|s|m|h)$",
              "description": "例: 30s, 5m"
            },
            "scrapeTimeout": {
              "type": "string",
              "pattern": "^[0-9]+(ms|s|m|h)$",
              "description": "例: 10s"
            },
            "scheme": { "type": "string", "enum": ["http", "https"] },
            "path": { "type": "string" },
            "relabelings": { "type": "array", "items": { "type": "object", "additionalProperties": true } },
            "metricRelabelings": { "type": "array", "items": { "type": "object", "additionalProperties": true } },
            "tlsConfig": { "type": "object", "additionalProperties": true }
          },
          "additionalProperties": false
        },
        "operators": { "$ref": "#/definitions/monitorSection" },
        "apps":      { "$ref": "#/definitions/monitorSection" },
        "argocd":    {
          "allOf": [
            { "$ref": "#/definitions/monitorSection" },
            { "properties": { "namespace": { "type": "string" } } }
          ]
        }
      },
      "additionalProperties": false
    }
  },
  "definitions": {
    "monitorSection": {
      "type": "object",
      "properties": {
        "enabled": { "type": "boolean", "default": true },
        "namespace": { "type": "string" },
        "targets": {
          "type": "array",
          "items": { "$ref": "#/definitions/monitorTarget" }
        }
      },
      "additionalProperties": false
    },
    "monitorTarget": {
      "type": "object",
      "properties": {
        "name": { "type": "string" },
        "kind": {
          "type": "string",
          "enum": ["ServiceMonitor", "PodMonitor"],
          "description": "省略時はテンプレ側のデフォルト（ServiceMonitor）"
        },
        "namespace": { "type": "string" },
        "selector": {
          "type": "object",
          "description": "ServiceMonitor 向けの Service セレクタ",
          "additionalProperties": true
        },
        "podSelector": {
          "type": "object",
          "description": "PodMonitor 向けの Pod セレクタ",
          "additionalProperties": true
        },
        "additionalLabels": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "endpoints": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/endpoint" }
        }
      },
      "required": ["name", "endpoints"],
      "anyOf": [
        { "required": ["selector"] },
        { "required": ["podSelector"] }
      ],
      "additionalProperties": false
    },
    "endpoint": {
      "type": "object",
      "properties": {
        "port": {
          "type": "string",
          "description": "Service のポート名（例: http, metrics）"
        },
        "targetPort": {
          "description": "Pod 側のポート番号または名前（PodMonitor で有効）",
          "oneOf": [
            { "type": "integer", "minimum": 1, "maximum": 65535 },
            { "type": "string" }
          ]
        },
        "path": { "type": "string" },
        "scheme": { "type": "string", "enum": ["http", "https"] },
        "interval": { "type": "string", "pattern": "^[0-9]+(ms|s|m|h)$" },
        "scrapeTimeout": { "type": "string", "pattern": "^[0-9]+(ms|s|m|h)$" },
        "relabelings": { "type": "array", "items": { "type": "object", "additionalProperties": true } },
        "metricRelabelings": { "type": "array", "items": { "type": "object", "additionalProperties": true } },
        "tlsConfig": { "type": "object", "additionalProperties": true },
        "sampleLimit": { "type": "integer", "minimum": 1 }
      },
      "additionalProperties": false,
      "oneOf": [
        { "required": ["port"] },
        { "required": ["targetPort"] }
      ]
    }
  },
  "additionalProperties": true
}
